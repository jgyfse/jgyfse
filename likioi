/*
 * @Description: è‡ªåŠ¨æ›´æ–°
 */
 
let currentVersion // å½“å‰ç‰ˆæœ¬
let version // æ–°ç‰ˆæœ¬
// const timeData = 60 * 1000 // æ£€æŸ¥é—´éš”æ—¶é—´
const timeData = 20 * 1000 // æ£€æŸ¥é—´éš”æ—¶é—´
let hidden = false // é¡µé¢æ˜¯å¦éšè—
let setTimeoutId
let needTip = true // é»˜è®¤å¼€å¯æç¤º
 
// è·å–ç‰ˆæœ¬å·
const getVersion = async () => {
  return fetch('/version.json?timestep=' + Date.now()).then((res) => res.json())
}
 
// æ£€æŸ¥æ›´æ–°
const checkUpdate = async () => {
  console.log('***************checkUpdate**************')
  const currentVersion = sessionStorage.getItem("version")
  version = (await getVersion()).version
  // æœ¬åœ°æ²¡æœ‰ versionï¼Œè¡¨ç¤ºåˆšè¿›å…¥ç³»ç»Ÿï¼Œç›´æ¥å¡å€¼
  if (!currentVersion) return sessionStorage.setItem("version", version)
 
  console.log("ğŸš€ ~ file: auto-update.js:19 ~ version:", version)
  console.log("ğŸš€ ~ file: auto-update.js:21 ~ currentVersion:", currentVersion)
  console.log("ğŸš€ ~ file: auto-update.js:23 ~ Number(version) !== Number(currentVersion):", Number(version) !== Number(currentVersion))
  let needRefresh = false
  if (Number(version) !== Number(currentVersion)) {
    console.log('%c å‘ç°æ–°ç‰ˆæœ¬~~~~~~', 'color: red')
    needRefresh = true
  }
  return needRefresh
}
 
// è‡ªåŠ¨æ›´æ–°
const autoUpdate = async () => {
  setTimeoutId = setTimeout(async () => {
    // é¡µé¢éšè—äº†å°±ä¸æ£€æŸ¥æ›´æ–°
    if (!hidden) {
      const willUpdate = await checkUpdate()
      console.log("ğŸš€ ~ file: auto-update.js:71 ~ setTimeoutId=setTimeout ~ willUpdate, version:", willUpdate, version)
 
      if (willUpdate && needTip) {
        // å»¶æ—¶æ›´æ–°ï¼Œé˜²æ­¢éƒ¨ç½²æœªå®Œæˆç”¨æˆ·å°±åˆ·æ–°ç©ºç™½
        setTimeout(()=>{
 
          // ----å¼¹æ¡†ç¡®è®¤---å…ˆç®€å•ç‚¹å¼¹æ¡†ç¡®è®¤ï¼Œå¯ä»¥ç”¨æ³¨é‡Šå†…çš„ï¼Œè·³è¿‡å³ä¸‹è§’é€šçŸ¥çš„å†…å®¹ï¼ˆStep3ã€4ï¼‰
          // const result = confirm('å‘ç°æ–°ç‰ˆæœ¬ï¼Œç‚¹å‡»ç¡®å®šæ›´æ–°')
          // if (result) {
          //   sessionStorage.setItem('version', version)
          //   location.reload() // åˆ·æ–°å½“å‰é¡µ
          // }
          // --------------
          
          //*****å³ä¸‹è§’é€šçŸ¥æç¤º */
          window.dispatchEvent(
            new CustomEvent("onmessageUpdate", {
              detail: {
                msg: "å‘ç°ç³»ç»Ÿç‰ˆæœ¬æ›´æ–°ï¼Œè¯·åˆ·æ–°é¡µé¢~",
                version: version
              },
            })
          )
          //******************* */
 
        }, 10000)
        needTip = false // å…³é—­æ›´æ–°æç¤ºï¼Œé˜²æ­¢é‡å¤æé†’
      }
    }
    console.log("ğŸš€ ~ file: auto-update.js:90 ~ autoUpdate ~ needTip: ", needTip)
    if (needTip) {
      console.warn('needTip autoUpdate');
      autoUpdate()
    }
  }, timeData)
}
 
// åœæ­¢æ£€æµ‹æ›´æ–°
const stop = () => {
  if (setTimeoutId) {
    clearTimeout(setTimeoutId)
    setTimeoutId = ''
  }
}
 
// å¼€å§‹æ£€æŸ¥æ›´æ–°
const start = async () => {
  // currentVersion = (await getVersion()).version
  autoUpdate()
  // ç›‘å¬é¡µé¢æ˜¯å¦éšè—
  document.addEventListener('visibilitychange', () => {
    hidden = document.hidden
    console.log("ğŸš€ ~ file: auto-update.js:64 ~ document.addEventListener ~ hidden, needTip:", hidden, needTip)
    // é¡µé¢éšè—äº†å°±ä¸æ£€æŸ¥æ›´æ–°ã€‚æˆ–è€…å·²ç»æœ‰ä¸€ä¸ªæç¤ºæ¡†äº†ï¼Œé˜²æ­¢é‡å¤æç¤ºã€‚
    if (!hidden && needTip) {
      autoUpdate()
    } else {
      stop()
    }
  })
}
 
export default { start }
 
